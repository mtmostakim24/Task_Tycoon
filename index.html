<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tycoon - Fixed Referral</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .btn { background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 10px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; }
        .notification { position: fixed; top: 20px; right: 20px; background: #4CAF50; padding: 15px; border-radius: 8px; display: none; z-index: 1000; }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div id="loginSection" class="container">
        <div class="card">
            <h2>ğŸ” à¦²à¦—à¦‡à¦¨</h2>
            <input type="tel" id="loginMobile" placeholder="à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦¨à¦®à§à¦¬à¦°" required>
            <input type="password" id="loginPassword" placeholder="à¦ªà¦¾à¦¸à¦“à¦¯à¦¼à¦¾à¦°à§à¦¡" required>
            <button class="btn" onclick="login()">à¦²à¦—à¦‡à¦¨</button>
            <p style="text-align: center; margin-top: 15px;">
                à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à§‡à¦‡? <a href="#" onclick="showRegister()" style="color: #4CAF50;">à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà§à¦°à§‡à¦¶à¦¨</a>
            </p>
        </div>
    </div>

    <div id="registerSection" class="container" style="display: none;">
        <div class="card">
            <h2>ğŸ“ à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà§à¦°à§‡à¦¶à¦¨</h2>
            <input type="text" id="regName" placeholder="à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®" required>
            <input type="tel" id="regMobile" placeholder="à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦¨à¦®à§à¦¬à¦°" required>
            <input type="password" id="regPassword" placeholder="à¦ªà¦¾à¦¸à¦“à¦¯à¦¼à¦¾à¦°à§à¦¡" required>
            <input type="text" id="regReferral" placeholder="à¦°à§‡à¦«à¦¾à¦° à¦•à§‹à¦¡ (à¦à¦šà§à¦›à¦¿à¦•)">
            <button class="btn" onclick="register()">à¦…à§à¦¯à¦¾à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦–à§à¦²à§à¦¨</button>
            <p style="text-align: center; margin-top: 15px;">
                Already have account? <a href="#" onclick="showLogin()" style="color: #4CAF50;">à¦²à¦—à¦‡à¦¨</a>
            </p>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="card">
            <h2>ğŸ‘‹ Welcome, <span id="userName"></span></h2>
            <p>ğŸ’° Balance: $<span id="balance">0.00</span></p>
            <p>ğŸ†” Your ID: <span id="userId"></span></p>
        </div>

        <div class="card">
            <h3>ğŸ“‹ Daily Tasks</h3>
            <p>âœ… Completed: <span id="completedTasks">0</span>/10</p>
            <button class="btn" onclick="doTask()">ğŸ¯ Do Task (+$0.10)</button>
        </div>

        <div class="card">
            <h3>ğŸ‘¥ Referral System</h3>
            <p>ğŸ“Š Your Referrals: <span id="referralCount">0</span></p>
            <p>ğŸ”— Your Referral Code: <strong id="userReferralCode"></strong></p>
            <button class="btn" onclick="copyReferral()">ğŸ“‹ Copy Referral Link</button>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ Referral History</h3>
            <div id="referralHistory"></div>
        </div>

        <button class="btn" onclick="logout()" style="background: #f44336;">ğŸšª Logout</button>
        
        <!-- ğŸ”¥ DEBUG SECTION -->
        <div class="card" style="background: rgba(255,0,0,0.1);">
            <h3>ğŸ› Debug Info</h3>
            <div id="debugInfo"></div>
            <button class="btn" onclick="showAllUsers()" style="background: #ff9800;">Show All Users</button>
        </div>
    </div>

    <script>
        // ğŸ”¥ FIXED: Single Database for All Users
        const DB_KEY = 'taskTycoonDB';
        
        function getDatabase() {
            const db = localStorage.getItem(DB_KEY);
            if (!db) {
                // Initialize empty database
                const initialDB = {
                    users: {},
                    referrals: {}
                };
                localStorage.setItem(DB_KEY, JSON.stringify(initialDB));
                return initialDB;
            }
            return JSON.parse(db);
        }

        function saveDatabase(db) {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        function getCurrentUser() {
            return JSON.parse(localStorage.getItem('currentUser'));
        }

        function setCurrentUser(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'error' ? '#f44336' : '#4CAF50';
            setTimeout(() => { notification.style.display = 'none'; }, 3000);
        }

        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function showLogin() {
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'block';
            
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                document.getElementById('regReferral').value = refCode;
                showNotification('ğŸ”— Referral code detected!');
            }
        }

        // ğŸ”¥ FIXED REGISTER FUNCTION
        function register() {
            const name = document.getElementById('regName').value;
            const mobile = document.getElementById('regMobile').value;
            const password = document.getElementById('regPassword').value;
            const referralCode = document.getElementById('regReferral').value;

            if (!name || !mobile || !password) {
                showNotification('âŒ à¦¸à¦¬ à¦¤à¦¥à§à¦¯ à¦¦à¦¿à¦¨', 'error');
                return;
            }

            const db = getDatabase();
            
            if (db.users[mobile]) {
                showNotification('âŒ à¦à¦‡ à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦¨à¦®à§à¦¬à¦° already registered', 'error');
                return;
            }

            // Create new user
            const newUser = {
                id: Date.now(),
                name: name,
                mobile: mobile,
                password: password,
                balance: 1.00,
                tasksCompleted: 0,
                referralCode: generateReferralCode(),
                totalEarned: 0,
                joinDate: new Date().toLocaleString()
            };

            // Save to database
            db.users[mobile] = newUser;
            saveDatabase(db);
            setCurrentUser(newUser);

            showNotification('ğŸ‰ à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà§à¦°à§‡à¦¶à¦¨ à¦¸à¦«à¦²! $1.00 à¦¬à§‹à¦¨à¦¾à¦¸ à¦ªà§‡à¦²à§‡à¦¨à¥¤');

            // ğŸ”¥ PROCESS REFERRAL
            if (referralCode) {
                processReferral(referralCode, newUser);
            }

            loadMainApp();
        }

        // ğŸ”¥ FIXED REFERRAL PROCESSING
        function processReferral(referrerCode, newUser) {
            console.log('ğŸ”„ Processing referral for:', newUser.name);
            
            const db = getDatabase();
            let referrer = null;

            // Find referrer by code
            for (let mobile in db.users) {
                const user = db.users[mobile];
                if (user.referralCode === referrerCode) {
                    referrer = user;
                    break;
                }
            }

            if (referrer) {
                console.log('âœ… Referrer found:', referrer.name);
                
                // Create referral record
                const referralId = Date.now();
                db.referrals[referralId] = {
                    id: referralId,
                    referrerMobile: referrer.mobile,
                    referredMobile: newUser.mobile,
                    referredName: newUser.name,
                    earned: 0,
                    status: 'pending',
                    date: new Date().toLocaleString()
                };

                saveDatabase(db);
                showNotification('ğŸ‘¥ Referral added successfully!');

                // Update display if referrer is current user
                const currentUser = getCurrentUser();
                if (currentUser && currentUser.mobile === referrer.mobile) {
                    loadMainApp();
                }
            } else {
                console.log('âŒ Referrer not found');
                showNotification('âŒ Invalid referral code', 'error');
            }
        }

        function login() {
            const mobile = document.getElementById('loginMobile').value;
            const password = document.getElementById('loginPassword').value;

            const db = getDatabase();
            const user = db.users[mobile];

            if (user && user.password === password) {
                setCurrentUser(user);
                showNotification('âœ… à¦²à¦—à¦‡à¦¨ à¦¸à¦«à¦²!');
                loadMainApp();
            } else {
                showNotification('âŒ à¦­à§à¦² à¦®à§‹à¦¬à¦¾à¦‡à¦² à¦¬à¦¾ à¦ªà¦¾à¦¸à¦“à¦¯à¦¼à¦¾à¦°à§à¦¡', 'error');
            }
        }

        function loadMainApp() {
            const user = getCurrentUser();
            const db = getDatabase();
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('registerSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            document.getElementById('userName').textContent = user.name;
            document.getElementById('userId').textContent = user.id;
            document.getElementById('balance').textContent = user.balance.toFixed(2);
            document.getElementById('completedTasks').textContent = user.tasksCompleted;
            document.getElementById('userReferralCode').textContent = user.referralCode;

            // Count user's referrals
            const userReferrals = Object.values(db.referrals).filter(ref => ref.referrerMobile === user.mobile);
            document.getElementById('referralCount').textContent = userReferrals.length;

            updateReferralHistory();
            updateDebugInfo();
        }

        function updateReferralHistory() {
            const user = getCurrentUser();
            const db = getDatabase();
            const historyDiv = document.getElementById('referralHistory');
            
            const userReferrals = Object.values(db.referrals).filter(ref => ref.referrerMobile === user.mobile);
            
            if (userReferrals.length === 0) {
                historyDiv.innerHTML = '<p>No referrals yet. Share your link!</p>';
                return;
            }

            let html = '';
            userReferrals.forEach(ref => {
                const progress = (ref.earned / 15) * 100;
                html += `
                    <div style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 10px 0;">
                        <p><strong>${ref.referredName}</strong></p>
                        <p>Earned: $${ref.earned.toFixed(2)} / $15.00</p>
                        <p>Progress: ${progress.toFixed(1)}%</p>
                        <p>Status: <span style="color: ${ref.status === 'active' ? '#4CAF50' : '#ff9800'}">${ref.status}</span></p>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }

        function doTask() {
            const user = getCurrentUser();
            const db = getDatabase();
            
            if (user.tasksCompleted >= 10) {
                showNotification('âœ… Daily tasks completed!', 'error');
                return;
            }

            user.tasksCompleted++;
            user.balance += 0.10;
            user.totalEarned += 0.10;

            // Update user in database
            db.users[user.mobile] = user;
            saveDatabase(db);
            setCurrentUser(user);

            // ğŸ”¥ UPDATE REFERRAL PROGRESS
            updateReferralProgress(user.mobile, 0.10);

            showNotification('âœ… Task completed! +$0.10');
            loadMainApp();
        }

        function updateReferralProgress(userMobile, amount) {
            const db = getDatabase();
            let updated = false;

            // Find referrals for this user
            for (let refId in db.referrals) {
                const ref = db.referrals[refId];
                if (ref.referredMobile === userMobile) {
                    ref.earned += amount;
                    
                    if (ref.earned >= 15 && ref.status === 'pending') {
                        ref.status = 'active';
                        // Add bonus to referrer
                        const referrer = db.users[ref.referrerMobile];
                        if (referrer) {
                            referrer.balance += 1.00;
                            db.users[ref.referrerMobile] = referrer;
                            showNotification('ğŸ‰ Referral bonus! +$1.00');
                        }
                    }
                    
                    db.referrals[refId] = ref;
                    updated = true;
                }
            }

            if (updated) {
                saveDatabase(db);
                loadMainApp();
            }
        }

        function copyReferral() {
            const user = getCurrentUser();
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${user.referralCode}`;
            navigator.clipboard.writeText(referralLink).then(() => {
                showNotification('ğŸ”— Referral link copied!');
            });
        }

        function logout() {
            localStorage.removeItem('currentUser');
            showNotification('ğŸ‘‹ Logged out');
            showLogin();
        }

        // ğŸ”¥ DEBUG FUNCTIONS
        function showAllUsers() {
            const db = getDatabase();
            console.log('ğŸ“Š ALL USERS:', db.users);
            console.log('ğŸ“ˆ ALL REFERRALS:', db.referrals);
            
            let debugHTML = '';
            debugHTML += `<p><strong>Total Users:</strong> ${Object.keys(db.users).length}</p>`;
            debugHTML += `<p><strong>Total Referrals:</strong> ${Object.keys(db.referrals).length}</p>`;
            
            document.getElementById('debugInfo').innerHTML = debugHTML;
        }

        function updateDebugInfo() {
            const db = getDatabase();
            document.getElementById('debugInfo').innerHTML = `
                <p>Users: ${Object.keys(db.users).length} | Referrals: ${Object.keys(db.referrals).length}</p>
            `;
        }

        // Initialize
        window.onload = function() {
            const currentUser = getCurrentUser();
            if (currentUser) {
                loadMainApp();
            } else {
                showLogin();
                
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    showRegister();
                    document.getElementById('regReferral').value = refCode;
                }
            }
        };
    </script>
</body>
</html>
